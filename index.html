<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"
            integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <title>FileUploader</title>
</head>
<body>
<input type="file" id="file"/>
<br/>
<progress id="progress" value="0" max="100"></progress>
</body>
<script>
    const socket = io.connect('http://localhost:3000', {
        cors: {origin: '*'},
        withCredentials: true,
        transports: ['websocket']
    });

    $('#file').on('change', function () {
        $('#progress').val('');
        const file = this.files[0];
        const chunkSize = 2048;

        socket.emit("upload-start", {size: file.size, name: file.name});

        let offset = 0;
        const reader = new FileReader();

        reader.onload = async e => {
            await socket.emit("upload-chunk", { data: new Uint8Array(e.target.result) });
            offset += chunkSize;
            if (offset < file.size) {
                readChunk();
            } else {
                await socket.emit("upload-end");
            }
        };

        const readChunk = () => {
            const chunk = file.slice(offset, offset + chunkSize);
            reader.readAsArrayBuffer(chunk);
        };
        readChunk();
    });

    socket.on("upload-progress", data => {
        $('#progress').val(data.progress);
    });

</script>
</html>
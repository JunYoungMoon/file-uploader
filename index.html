<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"
            integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <title>FileUploader</title>
</head>
<body>
<input type="file" id="file"/>
<br/>
<progress id="progress" value="0" max="100"></progress>
<br/>
<input type='button' id="submit" value='Submit' disabled/>
</body>
<script>
    let filename;

    $('#file').change(function () {
        const file = this.files[0];
        const chunkSize = 2048;
        const uniqueId = Date.now() + Math.random().toString(36).substr(2, 9);
        filename = uniqueId + '.' + file.name.slice(file.name.lastIndexOf('.') + 1);

        const socket = io.connect('http://localhost:3000', {
            cors: {origin: '*'},
            withCredentials: true,
            transports: ['websocket']
        });

        socket.emit("upload-start", {size: file.size, name: filename});
        $('#submit').attr("disabled", true);
        $('#progress').val(0);

        let offset = 0;
        const reader = new FileReader();

        reader.onload = async e => {
            await socket.emit("upload-chunk", {data: new Uint8Array(e.target.result)});
            offset += chunkSize;
            if (offset < file.size) {
                readChunk();
            } else {
                await socket.emit("upload-end");
                $('#submit').attr("disabled", false);
            }
        };

        const readChunk = () => {
            const chunk = file.slice(offset, offset + chunkSize);
            reader.readAsArrayBuffer(chunk);
        };
        readChunk();

        socket.on("upload-progress", data => {
            $('#progress').val(data.progress);
        });
    });

    $('#submit').click(function () {

        const data = {
            name: filename
        }
        fetch('/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
    });
</script>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"
            integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <title>FileUploader</title>
</head>
<body>
<input type="file" id="file">
</body>
<script>
    let socket;
    let env = 'dev';
    let location = 'v1';
    let offset = 0;
    const chunkSize = 1024 * 1024;

    if (env === 'dev') {
        socket = io.connect('http://localhost:3000', {
            cors: {origin: '*'},
            withCredentials: true,
            transports: ['websocket']
        });
    }

    $('#file').on('change', function () {
        const file = this.files[0];
        const chunkSize = 1024 * 1024;
        let currentChunk = 0;

        function readChunk() {
            const start = currentChunk * chunkSize;
            const end = start + chunkSize >= file.size ? file.size : start + chunkSize;
            const chunk = file.slice(start, end);
            currentChunk++;

            const reader = new FileReader();
            reader.onload = function (event) {
                socket.emit('chunk', event.target.result);

                if (end < file.size) {
                    readChunk();
                }
            };
            reader.readAsArrayBuffer(chunk);
        }

        readChunk();
    });

</script>
</html>